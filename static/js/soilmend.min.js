document.addEventListener("DOMContentLoaded",(function(){document.getElementById("year").textContent=(new Date).getFullYear();const e=document.getElementById("lawnInput"),t=(document.getElementById("grassInput"),document.getElementById("lawnPreview")),n=document.getElementById("analyzeBtn"),o=document.getElementById("demo-result"),r=document.getElementById("zipInput"),s=document.getElementById("slopeInput"),a=document.getElementById("progress-container"),i=document.getElementById("progress-fill"),l=document.getElementById("progress-text");let c=null,d=[],p=null,g=null,u=null,h=null;const m={compost:{title:"üå± Compost: Feed the Soil, Not Just the Grass",content:"\n        <p>Compost isn't fertilizer in the traditional sense ‚Äì it's food for the soil itself.</p>\n        \n        <p>Healthy lawns start below the surface. Compost adds organic matter that improves soil structure, supports beneficial microbes, and helps soil hold both water and nutrients more effectively.</p>\n        \n        <p>That's why SoilMend often recommends light compost use instead of aggressive treatments.</p>\n        \n        <h4>What Compost Actually Does</h4>\n        <p>When you apply compost, you're not forcing growth ‚Äì you're restoring balance.</p>\n        \n        <p>Compost helps:</p>\n        <ul>\n          <li>Improve compacted or lifeless soil</li>\n          <li>Increase water retention during dry periods</li>\n          <li>Reduce runoff and erosion after heavy rain</li>\n          <li>Support steady, resilient grass growth over time</li>\n        </ul>\n        \n        <p>This is especially important in areas with bare soil, slopes, or tree cover where grass struggles.</p>\n        \n        <h4>When SoilMend Suggests Compost</h4>\n        <p>In your SoilMend plan, you may see guidance like:</p>\n        <p style=\"font-style:italic;color:var(--green);\">\"Apply a thin compost top-dressing.\"</p>\n        \n        <p>This usually means:</p>\n        <ul>\n          <li>Grass growth looks weak or patchy</li>\n          <li>Bare soil is increasing</li>\n          <li>The season supports recovery (often spring or fall)</li>\n          <li>You want improvement without disturbing the lawn</li>\n        </ul>\n        \n        <p>Compost is suggested only when it helps ‚Äì never by default.</p>\n        \n        <h4>How to Apply Compost (Gently)</h4>\n        <p>You don't need to dig or till.</p>\n        \n        <p>For most lawns:</p>\n        <ol>\n          <li>Use finished, dark, earthy-smelling compost</li>\n          <li>Spread a very thin layer (about ¬º inch)</li>\n          <li>Focus on bare or thinning areas</li>\n          <li>Let rain and soil life do the work</li>\n        </ol>\n        \n        <p><strong>If you can still see the grass blades, you've applied the right amount.</strong></p>\n        \n        <h4>Compost vs. Fertilizer</h4>\n        <table>\n          <tr>\n            <th>Compost</th>\n            <th>Fertilizer</th>\n          </tr>\n          <tr>\n            <td>Improves soil health</td>\n            <td>Pushes fast growth</td>\n          </tr>\n          <tr>\n            <td>Slow, lasting benefits</td>\n            <td>Short-term results</td>\n          </tr>\n          <tr>\n            <td>Reduces erosion & runoff</td>\n            <td>Can increase runoff</td>\n          </tr>\n          <tr>\n            <td>Supports microbes</td>\n            <td>Feeds plants directly</td>\n          </tr>\n        </table>\n        \n        <p><strong>SoilMend prioritizes compost because healthy soil solves problems before they show up above ground.</strong></p>\n      "},mulch:{title:"üçÇ Mulch: Nature's Soil Protector",content:"\n        <p>Mulch is any material that covers bare soil to protect it from erosion, retain moisture, and support soil life.</p>\n        \n        <h4>Why Mulch Matters</h4>\n        <ul>\n          <li>Prevents soil from washing away during rain</li>\n          <li>Keeps soil temperature stable</li>\n          <li>Reduces water evaporation</li>\n          <li>Breaks down slowly to feed soil organisms</li>\n        </ul>\n        \n        <h4>Types of Mulch</h4>\n        <ul>\n          <li><strong>Organic:</strong> Wood chips, leaves, grass clippings, straw</li>\n          <li><strong>Living:</strong> Low-growing groundcover plants</li>\n          <li><strong>Temporary:</strong> Cardboard or burlap for severe erosion</li>\n        </ul>\n        \n        <p>SoilMend recommends light, organic mulch for exposed areas ‚Äì especially on slopes.</p>\n      "},erosion:{title:"üíß Understanding Erosion Risk",content:"\n        <p>Erosion happens when soil is exposed and unprotected, allowing water or wind to carry it away.</p>\n        \n        <h4>What Increases Erosion Risk</h4>\n        <ul>\n          <li>Bare soil (no grass or plant cover)</li>\n          <li>Slopes and hillsides</li>\n          <li>Heavy rainfall or runoff</li>\n          <li>Compacted soil that can't absorb water</li>\n        </ul>\n        \n        <h4>How SoilMend Estimates Risk</h4>\n        <p>We analyze:</p>\n        <ul>\n          <li>Percentage of bare soil in your photo</li>\n          <li>Slope information you provide</li>\n          <li>Seasonal rainfall patterns for your area</li>\n        </ul>\n        \n        <p><strong>Low risk:</strong> Good grass coverage, flat terrain<br>\n        <strong>Moderate risk:</strong> Some bare patches, gentle slopes<br>\n        <strong>High risk:</strong> Significant bare soil or steep slopes</p>\n      "},shadegrass:{title:"üå≥ Shade-Tolerant Grass Species",content:"\n        <p>Trees create beautiful shade, but they also compete with grass for light, water, and nutrients. The good news: some grass species thrive in partial shade!</p>\n        \n        <h4>Why Regular Grass Struggles Under Trees</h4>\n        <ul>\n          <li>Reduced sunlight (grass needs 4-6 hours minimum)</li>\n          <li>Tree roots compete for water and nutrients</li>\n          <li>Leaf litter can smother grass</li>\n          <li>Drier soil in tree rain shadows</li>\n        </ul>\n        \n        <h4>Best Shade-Tolerant Grass Options</h4>\n        \n        <p><strong>Cool-Season Grasses (Northern climates):</strong></p>\n        <ul>\n          <li><strong>Fine Fescue:</strong> Best shade tolerance (can handle 80% shade)</li>\n          <li><strong>Tall Fescue:</strong> Moderate shade, deep roots, drought-tolerant</li>\n          <li><strong>Perennial Ryegrass:</strong> Good in light shade, quick germination</li>\n        </ul>\n        \n        <p><strong>Warm-Season Grasses (Southern climates):</strong></p>\n        <ul>\n          <li><strong>St. Augustine:</strong> Best warm-season shade tolerance</li>\n          <li><strong>Zoysia:</strong> Moderate shade, slow-growing but durable</li>\n          <li><strong>Centipede:</strong> Low maintenance, tolerates light shade</li>\n        </ul>\n        \n        <h4>Tips for Growing Grass Under Trees</h4>\n        <ol>\n          <li>Choose the right species for your climate and shade level</li>\n          <li>Overseed in fall when trees drop leaves</li>\n          <li>Raise mowing height by 1 inch to maximize photosynthesis</li>\n          <li>Water deeply but less frequently</li>\n          <li>Apply compost to improve soil under tree canopy</li>\n          <li>Prune lower branches to increase light penetration</li>\n        </ol>\n        \n        <h4>When to Consider Alternatives</h4>\n        <p>If trees provide deep shade (less than 3 hours sun), consider:</p>\n        <ul>\n          <li>Shade-loving groundcovers (hostas, pachysandra, vinca)</li>\n          <li>Mulch beds around tree bases</li>\n          <li>Natural leaf litter areas</li>\n        </ul>\n        \n        <p><strong>Remember:</strong> Some bare soil under mature trees is natural. Focus on preventing erosion rather than forcing grass growth.</p>\n      "}};function f(){a.style.display="none"}function w(e,t){i.style.width=e+"%",i.textContent=e+"%",l.textContent=t}async function y(){if(u)return u;const e=await fetch("./static/suggestions/grass_species_care_rules.json");return u=await e.json(),u}async function b(e){const t=document.getElementById("grass-id-section"),n=document.getElementById("user-grass-gallery"),o=document.getElementById("grass-card-grid");if(!t||!n||!o)return;t.style.display="block",n.innerHTML=e.slice(0,3).map((e=>`\n    <img src="${e}" alt="User grass photo">\n  `)).join("");const r=await async function(){const e=(await y()).species;return Object.entries(e).map((([e,t])=>({key:e,name:t.commonName,img:`./static/grass/${e}.jpg`,traits:[`${t.seasonType}-season`,`Shade: ${t.care.shadeTolerance}`,`Mow: ${t.care.mowHeight}`]})))}();o.innerHTML=r.map((e=>`\n    <div class="grass-card" onclick="showGrassRules('${e.key}')">\n      <img src="${e.img}" style="width:100%;border-radius:6px;">\n      <strong>${e.name}</strong>\n      <ul>\n        ${e.traits.map((e=>`<li>${e}</li>`)).join("")}\n      </ul>\n    </div>\n  `)).join("")}window.showTooltip=function(e,t={}){const n=m[e];if(!n)return;let o=n.content;if("compost"===e&&t.season){const e=function(e,t){let n="";if(e){const t=parseInt(e);t>=77e3&&t<=77099?n="Houston area - mild winters allow year-round application":t>=1e4&&t<=14999?n="Northern climate - spring and fall are best windows":t>=3e4&&t<=39999?n="Southern climate - avoid mid-summer heat stress":t>=9e4&&t<=96699&&(n="Western climate - timing varies by elevation and moisture")}return{timing:{winter:"Wait until early spring when soil can be worked",spring:"Ideal time! Apply compost now for active growth season",summer:"Can apply, but water retention is key - compost helps!",fall:"Excellent timing! Helps prepare lawn for winter"}[t],locationNote:n}}(t.zipCode,t.season);o=`\n        ${t.zipCode?`<div class="location-badge">üìç ${t.zipCode}</div>`:""}\n        <h4>Best Time to Apply (${t.season})</h4>\n        <p style="background:var(--bg);padding:15px;border-radius:8px;margin:15px 0;">\n          <strong>${e.timing}</strong>\n          ${e.locationNote?`<br><em style="font-size:0.95em;">${e.locationNote}</em>`:""}\n        </p>\n      `+o}const r=document.createElement("div");r.className="tooltip-modal active",r.innerHTML=`\n      <div class="tooltip-content">\n        <button class="tooltip-close" onclick="this.closest('.tooltip-modal').remove()">√ó</button>\n        <h3>${n.title}</h3>\n        ${o}\n      </div>\n    `,r.addEventListener("click",(e=>{e.target===r&&r.remove()})),document.body.appendChild(r)},e.addEventListener("change",(e=>{console.log("Lawn input changed",e.target.files),t.innerHTML="",c=e.target.files[0],c?(console.log("Creating preview for:",c.name),function(e,t){const n=document.createElement("img"),o=new FileReader;o.onload=()=>n.src=o.result,o.readAsDataURL(e),t.appendChild(n)}(c,t),n.disabled=!1,console.log("Analyze button enabled")):console.log("No file selected")}));const v=["lawn","grass","lawn mower","park bench","fountain","villa","lakeside","valley","geyser","alp","sandbar","promontory","seashore","cliff","coral reef"],k=["person","people","face","cat","dog","animal","pet","car","vehicle","indoor","furniture","screen","computer","phone","food","kitchen"];async function P(e){if("undefined"==typeof mobilenet)return console.warn("MobileNet not available, skipping photo validation"),{valid:!0};try{const t=await async function(){if(g)return g;if("undefined"==typeof mobilenet){console.log("Waiting for MobileNet to load...");let e=0;for(;"undefined"==typeof mobilenet&&e<50;)await new Promise((e=>setTimeout(e,100))),e++;if("undefined"==typeof mobilenet)throw new Error("MobileNet library failed to load")}return console.log("Loading MobileNet model..."),g=await mobilenet.load(),console.log("MobileNet model loaded successfully"),g}(),n=await t.classify(e);console.log("MobileNet predictions:",n);for(let e=0;e<Math.min(3,n.length);e++){const t=n[e],o=t.className.toLowerCase();for(const e of k)if(o.includes(e)&&t.probability>.3)return{valid:!1,message:`This looks like a photo of ${t.className.toLowerCase()}, not a lawn. Please upload a photo of your yard or grass.`}}return!n.some((e=>{const t=e.className.toLowerCase();return v.some((e=>t.includes(e)))}))&&n[0].probability>.4?{valid:!1,message:"This doesn't appear to be a lawn or yard photo. Please upload a clear photo of your grass or soil."}:{valid:!0}}catch(e){return console.warn("MobileNet validation failed, proceeding without validation:",e),{valid:!0}}}function S(e){if(!e)return"other";const t=e.toLowerCase().replace(/[_-]/g," "),n={grass:["grass","field"],tree:["tree","plant","bush"],structure:["house","building","fence","road","pavement"],bare:["soil","earth"],sky:["sky"]};for(const[e,o]of Object.entries(n))if(o.some((e=>t.includes(e))))return e;return"other"}function C(e){const t=new Map;for(const[n,o]of Object.entries(e))t.set(o.join(","),n);return t}function $(e){const t=document.createElement("canvas"),n=t.getContext("2d");t.width=t.height=256,n.drawImage(e,0,0,256,256);const o=n.getImageData(0,0,256,256).data;let r=0,s=0,a=0,i=0;for(let e=0;e<o.length;e+=4){const t=o[e],n=o[e+1],l=o[e+2];n>1.15*t&&n>1.15*l?r++:t>140&&n>140&&l<120?s++:t>n&&n>l&&a++,i++}return{greenRatio:r/i,yellowRatio:s/i,brownRatio:a/i}}function M(e){return[11,0,1].includes(e)?"winter":[2,3,4].includes(e)?"spring":[5,6,7].includes(e)?"summer":"fall"}n.addEventListener("click",(async()=>{if(console.log("Analyze button clicked"),c){n.disabled=!0,o.style.display="none",a.style.display="block",w(0,"Starting analysis...");try{console.log("Starting analysis..."),w(5,"Loading image...");const e=new Image;e.src=URL.createObjectURL(c),await e.decode(),console.log("Image loaded successfully"),w(10,"Validating photo with AI..."),console.log("Calling validateLawnPhoto...");const t=await P(e);if(console.log("Validation result:",t),!t.valid)return l.style.color="red",w(100,t.message),void setTimeout((()=>{l.style.color="",f(),n.disabled=!1}),4e3);w(20,"Preparing AI model...");const a=await async function(){return p||(await tf.ready(),w(10,"Loading AI model..."),p=await deeplab.load({base:"ade20k",quantizationBytes:2}),w(30,"Model loaded successfully"),p)}();w(50,"Analyzing lawn segmentation...");const i=await a.segment(e);w(70,"Processing segmentation data...");const g=s?.value||null,u=r?.value?.trim()||null,m=function(e,t,n,o){const r=new Map;Object.entries(t).forEach((([e,t])=>{r.set(t.join(","),e.toLowerCase())}));const s=[],a=[];for(let t=0;t<e.length;t+=4){const o=t/4%n,i=Math.floor(t/4/n),l=`${e[t]},${e[t+1]},${e[t+2]}`,c=r.get(l)||"";(c.includes("tree")||c.includes("plant"))&&s.push([o,i]),(c.includes("soil")||c.includes("earth"))&&a.push([o,i])}if(0===s.length||0===a.length)return!1;let i=0;const l=.08*Math.min(n,o);for(const[e,t]of a)for(const[n,o]of s){const r=e-n,s=t-o;if(r*r+s*s<l*l){i++;break}}return i/a.length>.25}(i.segmentationMap,i.legend,e.width,e.height);!function(e,t,n,o){const r=document.getElementById("originalCanvas"),s=document.getElementById("segmentationCanvas");r.width=s.width=n,r.height=s.height=o,r.getContext("2d").drawImage(e,0,0,n,o);const a=s.getContext("2d"),i=new ImageData(new Uint8ClampedArray(t),n,o);a.putImageData(i,0,0),r.style.display="block",s.style.display="block"}(e,i.segmentationMap,i.width,i.height);const y=M((new Date).getMonth());let v="winter"===y?function(e,t,n){const o=C(n),r={grass:0,dormant:0,tree:0,structure:0,bare:0,sky:0,other:0};let s=0;const a=document.createElement("canvas"),i=a.getContext("2d");a.width=a.height=256,i.drawImage(t,0,0,256,256);const l=i.getImageData(0,0,256,256).data;for(let t=0;t<e.length;t+=4){const n=`${e[t]},${e[t+1]},${e[t+2]}`;let a=S(o.get(n));if("grass"===a){const e=l[t],n=l[t+1],o=l[t+2];e>180&&n>160&&o>140&&(a="dormant")}r[a]=(r[a]||0)+1,"sky"!==a&&s++}return{grassPercent:r.grass/s,dormantPercent:r.dormant/s,treePercent:r.tree/s,structurePercent:r.structure/s,bareSoilPercent:r.bare/s,treeCoverage:r.tree}}(i.segmentationMap,e,i.legend):function(e,t){const n=C(t),o={grass:0,tree:0,structure:0,bare:0,pavement:0,fence:0,road:0,sky:0,other:0};let r=0;for(let t=0;t<e.length;t+=4){const s=`${e[t]},${e[t+1]},${e[t+2]}`,a=S(n.get(s));o[a]++,"sky"!==a&&r++}return{grassPercent:o.grass/r,treePercent:o.tree/r,structurePercent:o.structure/r,bareSoilPercent:o.bare/r,treeCoverage:o.tree}}(i.segmentationMap,i.legend);(100*v.grassPercent).toFixed(1),(100*v.treePercent).toFixed(1),(100*v.structurePercent).toFixed(1),(100*v.bareSoilPercent).toFixed(1);w(75,"Analyzing grass health...");let k=null;if(d.length){const e={greenRatio:0,yellowRatio:0,brownRatio:0};for(const t of d){const n=new Image;n.src=URL.createObjectURL(t),await n.decode();const o=$(n);e.greenRatio+=o.greenRatio,e.yellowRatio+=o.yellowRatio,e.brownRatio+=o.brownRatio}Object.keys(e).forEach((t=>e[t]/=d.length)),k=function({greenRatio:e,yellowRatio:t,brownRatio:n}){const o=e=>Math.max(0,Math.min(100,Math.round(e)));return{growthScore:o(100*e-80*t),protectionScore:o(50*(e+(1-n)))}}(e)}else k={growthScore:null,protectionScore:null};const I=function(e,t){return"winter"===t?"Grass may appear yellow in winter ‚Äì this is normal dormancy üå±":null===e?"Need to upload grass photos":null}(k.growthScore,y);w(85,"Loading grass identification guide...");const T=function(){const e=document.getElementById("grassInput");return e&&e.files?Array.from(e.files).slice(0,3).map((e=>URL.createObjectURL(e))):[]}();T.length>0?b(T):document.getElementById("grass-id-section").style.display="none",w(95,"Generating care plan...");const L=function(e){const t=M(e.month),n=function({bareSoilPercent:e,slopeHint:t}){let n="low";return e>.25&&(n="moderate"),e>.45&&(n="high"),"steep"===t&&e>.2&&(n="high"),n}(e),o=void 0!==e.treePercent&&e.treePercent>.15&&e.bareSoilPercent>.15,r="winter"===t&&void 0!==e.dormantPercent?Math.max(0,e.bareSoilPercent-e.dormantPercent):e.bareSoilPercent,s=r<.15,a=e.hasTreeBareProximity||"number"==typeof e.treePercent&&e.treePercent>.02&&e.bareSoilPercent>.18;h={zipCode:e.zipCode,season:t};const i=[{week:"Week 1 ‚Äì Observe & Protect",actions:["Avoid major lawn work.","low"!==n?'Add light <span class="tooltip-trigger" onclick="showTooltip(\'mulch\')">mulch</span> or leaf cover to exposed soil.':"Leave grass clippings and thin branches where they fall."]},{week:"Week 2 ‚Äì Gentle Support",actions:[o?'üå≥ Trees detected with bare patches underneath. \n             Consider <span class="tooltip-trigger"\n             onclick="showTooltip(\'shadegrass\')">\n             shade-tolerant grass species</span> for better coverage.':e.growthScore<50&&"spring"===t?`Apply a thin <span class="tooltip-trigger"\n                 onclick="showTooltip('compost', {season: '${t}', zipCode: '${e.zipCode||""}'})">\n                 compost</span> top-dressing.`:"No fertilization needed.","steep"===e.slopeHint?"Avoid disturbing soil downhill on slopes.":"Limit foot traffic in thin areas."]},{week:"Week 3 ‚Äì Reassess",actions:["Observe runoff after rainfall.","high"===n?'Reinforce exposed patches with organic cover. <span class="tooltip-trigger" onclick="showTooltip(\'erosion\')">Learn about erosion risk</span>.':"No changes needed if soil remains covered."]},{week:"Week 4 ‚Äì Prepare Ahead",actions:["summer"===t?"Prepare shade or moisture-retaining cover.":"Plan adjustments for next growth window.",e.protectionScore>=60?"Maintain current coverage.":"Focus next month on improving coverage"]}];return i.forEach((n=>{r>.45?n.actions.push(`High bare soil detected ‚Äì prioritize replanting, <span class="tooltip-trigger" onclick="showTooltip('mulch')">mulch</span>, and <span class="tooltip-trigger" onclick="showTooltip('compost', {season: '${t}', zipCode: '${e.zipCode||""}'})">compost</span>!`):s&&n.actions.push("Excellent coverage! Keep maintaining your healthy lawn üåü")})),a&&i[1].actions.push('Trees detected with bare patches underneath. Consider <span class="tooltip-trigger" onclick="showTooltip(\'shadegrass\')">shade-tolerant grass species</span> for better coverage.'),{plan:i,badge:s?"üèÖ Excellent Lawn Coverage!":null}}({...k,hasTreeBareProximity:m,bareSoilPercent:v.bareSoilPercent,dormantPercent:v.dormantPercent,treePercent:v.treePercent,treeCoverage:v.treeCoverage,slopeHint:g,zipCode:u,month:(new Date).getMonth()});w(100,"Analysis complete!"),o.innerHTML=`\n      ${function(e,t){return`\n    <h3>Segmentation Overview</h3>\n    <div style="display:flex;width:100%;height:40px;border-radius:6px;overflow:hidden;">\n      ${[{name:"Grass",pct:100*e.grassPercent,color:"green"},{name:"Other Plants",pct:100*e.treePercent,color:"darkgreen"},{name:"Structures",pct:100*e.structurePercent,color:"gray"},..."winter"===t&&void 0!==e.dormantPercent?[{name:"Dormant Grass",pct:100*e.dormantPercent,color:"#dcd0a1",tooltip:"Normal winter dormant grass"}]:[],{name:"Bare Soil",pct:100*e.bareSoilPercent,color:"brown"}].map((e=>`\n        <div style="\n          flex:${e.pct};\n          background:${e.color};\n          position: relative;\n        " title="${e.tooltip||`${e.name}: ${e.pct.toFixed(1)}%`}">\n        </div>\n      `)).join("")}\n    </div>\n  `}(v,y)}\n      <h3>Grass Health</h3>\n      Growth: ${null!==k.growthScore?k.growthScore+"/100":I}<br>\n      Protection: ${null!==k.protectionScore?k.protectionScore+"/100":I}\n      ${function({plan:e,badge:t}){return`\n    <h4>üå± 1-Month Low-Intervention Plan</h4>\n    ${t?`<div style="font-size:1.2em;color:#27ae60;margin-bottom:15px;">${t}</div>`:""}\n    ${e.map((e=>`\n      <div class="plan-week">\n        <strong>${e.week}</strong>\n        <ul>\n          ${e.actions.map((e=>`<li>${e}</li>`)).join("")}\n        </ul>\n      </div>\n    `)).join("")}\n  `}(L)}\n    `,o.style.display="block",setTimeout((()=>{f()}),1e3)}catch(e){console.error("Analysis error:",e),w(0,"Error during analysis. Please try again."),setTimeout((()=>{f()}),3e3)}n.disabled=!1}else console.log("No lawn image selected")}))}));