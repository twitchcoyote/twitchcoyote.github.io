document.addEventListener("DOMContentLoaded",(function(){document.getElementById("year").textContent=(new Date).getFullYear();const e=document.getElementById("lawnInput"),t=(document.getElementById("grassInput"),document.getElementById("lawnPreview")),n=document.getElementById("analyzeBtn"),o=document.getElementById("demo-result"),a=document.getElementById("zipInput"),r=document.getElementById("slopeInput"),i=document.getElementById("progress-container"),s=document.getElementById("progress-fill"),l=document.getElementById("progress-text");let c=null,d=[],p=null,g=null,u=null,m=null,h=null;const f={compost:{title:"üå± Compost: Feed the Soil, Not Just the Grass",content:"\n        <p>Compost isn't fertilizer in the traditional sense ‚Äì it's food for the soil itself.</p>\n        \n        <p>Healthy lawns start below the surface. Compost adds organic matter that improves soil structure, supports beneficial microbes, and helps soil hold both water and nutrients more effectively.</p>\n        \n        <p>That's why SoilMend often recommends light compost use instead of aggressive treatments.</p>\n        \n        <h4>What Compost Actually Does</h4>\n        <p>When you apply compost, you're not forcing growth ‚Äì you're restoring balance.</p>\n        \n        <p>Compost helps:</p>\n        <ul>\n          <li>Improve compacted or lifeless soil</li>\n          <li>Increase water retention during dry periods</li>\n          <li>Reduce runoff and erosion after heavy rain</li>\n          <li>Support steady, resilient grass growth over time</li>\n        </ul>\n        \n        <p>This is especially important in areas with bare soil, slopes, or tree cover where grass struggles.</p>\n        \n        <h4>When SoilMend Suggests Compost</h4>\n        <p>In your SoilMend plan, you may see guidance like:</p>\n        <p style=\"font-style:italic;color:var(--green);\">\"Apply a thin compost top-dressing.\"</p>\n        \n        <p>This usually means:</p>\n        <ul>\n          <li>Grass growth looks weak or patchy</li>\n          <li>Bare soil is increasing</li>\n          <li>The season supports recovery (often spring or fall)</li>\n          <li>You want improvement without disturbing the lawn</li>\n        </ul>\n        \n        <p>Compost is suggested only when it helps ‚Äì never by default.</p>\n        \n        <h4>How to Apply Compost (Gently)</h4>\n        <p>You don't need to dig or till.</p>\n        \n        <p>For most lawns:</p>\n        <ol>\n          <li>Use finished, dark, earthy-smelling compost</li>\n          <li>Spread a very thin layer (about ¬º inch)</li>\n          <li>Focus on bare or thinning areas</li>\n          <li>Let rain and soil life do the work</li>\n        </ol>\n        \n        <p><strong>If you can still see the grass blades, you've applied the right amount.</strong></p>\n        \n        <h4>Compost vs. Fertilizer</h4>\n        <table>\n          <tr>\n            <th>Compost</th>\n            <th>Fertilizer</th>\n          </tr>\n          <tr>\n            <td>Improves soil health</td>\n            <td>Pushes fast growth</td>\n          </tr>\n          <tr>\n            <td>Slow, lasting benefits</td>\n            <td>Short-term results</td>\n          </tr>\n          <tr>\n            <td>Reduces erosion & runoff</td>\n            <td>Can increase runoff</td>\n          </tr>\n          <tr>\n            <td>Supports microbes</td>\n            <td>Feeds plants directly</td>\n          </tr>\n        </table>\n        \n        <p><strong>SoilMend prioritizes compost because healthy soil solves problems before they show up above ground.</strong></p>\n      "},mulch:{title:"üçÇ Mulch: Nature's Soil Protector",content:"\n        <p>Mulch is any material that covers bare soil to protect it from erosion, retain moisture, and support soil life.</p>\n        \n        <h4>Why Mulch Matters</h4>\n        <ul>\n          <li>Prevents soil from washing away during rain</li>\n          <li>Keeps soil temperature stable</li>\n          <li>Reduces water evaporation</li>\n          <li>Breaks down slowly to feed soil organisms</li>\n        </ul>\n        \n        <h4>Types of Mulch</h4>\n        <ul>\n          <li><strong>Organic:</strong> Wood chips, leaves, grass clippings, straw</li>\n          <li><strong>Living:</strong> Low-growing groundcover plants</li>\n          <li><strong>Temporary:</strong> Cardboard or burlap for severe erosion</li>\n        </ul>\n        \n        <p>SoilMend recommends light, organic mulch for exposed areas ‚Äì especially on slopes.</p>\n      "},erosion:{title:"üíß Understanding Erosion Risk",content:"\n        <p>Erosion happens when soil is exposed and unprotected, allowing water or wind to carry it away.</p>\n        \n        <h4>What Increases Erosion Risk</h4>\n        <ul>\n          <li>Bare soil (no grass or plant cover)</li>\n          <li>Slopes and hillsides</li>\n          <li>Heavy rainfall or runoff</li>\n          <li>Compacted soil that can't absorb water</li>\n        </ul>\n        \n        <h4>How SoilMend Estimates Risk</h4>\n        <p>We analyze:</p>\n        <ul>\n          <li>Percentage of bare soil in your photo</li>\n          <li>Slope information you provide</li>\n          <li>Seasonal rainfall patterns for your area</li>\n        </ul>\n        \n        <p><strong>Low risk:</strong> Good grass coverage, flat terrain<br>\n        <strong>Moderate risk:</strong> Some bare patches, gentle slopes<br>\n        <strong>High risk:</strong> Significant bare soil or steep slopes</p>\n      "},shadegrass:{title:"üå≥ Shade-Tolerant Grass Species",content:"\n        <p>Trees create beautiful shade, but they also compete with grass for light, water, and nutrients. The good news: some grass species thrive in partial shade!</p>\n        \n        <h4>Why Regular Grass Struggles Under Trees</h4>\n        <ul>\n          <li>Reduced sunlight (grass needs 4-6 hours minimum)</li>\n          <li>Tree roots compete for water and nutrients</li>\n          <li>Leaf litter can smother grass</li>\n          <li>Drier soil in tree rain shadows</li>\n        </ul>\n        \n        <h4>Best Shade-Tolerant Grass Options</h4>\n        \n        <p><strong>Cool-Season Grasses (Northern climates):</strong></p>\n        <ul>\n          <li><strong>Fine Fescue:</strong> Best shade tolerance (can handle 80% shade)</li>\n          <li><strong>Tall Fescue:</strong> Moderate shade, deep roots, drought-tolerant</li>\n          <li><strong>Perennial Ryegrass:</strong> Good in light shade, quick germination</li>\n        </ul>\n        \n        <p><strong>Warm-Season Grasses (Southern climates):</strong></p>\n        <ul>\n          <li><strong>St. Augustine:</strong> Best warm-season shade tolerance</li>\n          <li><strong>Zoysia:</strong> Moderate shade, slow-growing but durable</li>\n          <li><strong>Centipede:</strong> Low maintenance, tolerates light shade</li>\n        </ul>\n        \n        <h4>Tips for Growing Grass Under Trees</h4>\n        <ol>\n          <li>Choose the right species for your climate and shade level</li>\n          <li>Overseed in fall when trees drop leaves</li>\n          <li>Raise mowing height by 1 inch to maximize photosynthesis</li>\n          <li>Water deeply but less frequently</li>\n          <li>Apply compost to improve soil under tree canopy</li>\n          <li>Prune lower branches to increase light penetration</li>\n        </ol>\n        \n        <h4>When to Consider Alternatives</h4>\n        <p>If trees provide deep shade (less than 3 hours sun), consider:</p>\n        <ul>\n          <li>Shade-loving groundcovers (hostas, pachysandra, vinca)</li>\n          <li>Mulch beds around tree bases</li>\n          <li>Natural leaf litter areas</li>\n        </ul>\n        \n        <p><strong>Remember:</strong> Some bare soil under mature trees is natural. Focus on preventing erosion rather than forcing grass growth.</p>\n      "}};function y(){i.style.display="none"}function w(e,t){s.style.width=e+"%",s.textContent=e+"%",l.textContent=t}async function b(){if(m)return m;const e=await fetch("./static/suggestions/grass_species_care_rules.json");return m=await e.json(),m}async function v(e){const t=document.getElementById("grass-id-section"),n=document.getElementById("user-grass-gallery"),o=document.getElementById("grass-card-grid");if(!t||!n||!o)return;t.style.display="block",n.innerHTML=e.slice(0,3).map((e=>`\n    <img src="${e}" alt="User grass photo">\n  `)).join("");const a=await async function(){const e=(await b()).species;return Object.entries(e).map((([e,t])=>({key:e,name:t.commonName,img:`./static/grass/${e}.jpg`,traits:[`${t.seasonType}-season`,`Shade: ${t.care.shadeTolerance}`,`Mow: ${t.care.mowHeight}`]})))}();o.innerHTML=a.map((e=>`\n    <div class="grass-card" onclick="showGrassRules('${e.key}')">\n      <img src="${e.img}" style="width:100%;border-radius:6px;">\n      <strong>${e.name}</strong>\n      <ul>\n        ${e.traits.map((e=>`<li>${e}</li>`)).join("")}\n      </ul>\n    </div>\n  `)).join("")}window.showTooltip=function(e,t={}){const n=f[e];if(!n)return;let o=n.content;if("compost"===e&&t.season){const e=function(e,t){let n="";if(e){const t=parseInt(e);t>=77e3&&t<=77099?n="Houston area - mild winters allow year-round application":t>=1e4&&t<=14999?n="Northern climate - spring and fall are best windows":t>=3e4&&t<=39999?n="Southern climate - avoid mid-summer heat stress":t>=9e4&&t<=96699&&(n="Western climate - timing varies by elevation and moisture")}return{timing:{winter:"Wait until early spring when soil can be worked",spring:"Ideal time! Apply compost now for active growth season",summer:"Can apply, but water retention is key - compost helps!",fall:"Excellent timing! Helps prepare lawn for winter"}[t],locationNote:n}}(t.zipCode,t.season);o=`\n        ${t.zipCode?`<div class="location-badge">üìç ${t.zipCode}</div>`:""}\n        <h4>Best Time to Apply (${t.season})</h4>\n        <p style="background:var(--bg);padding:15px;border-radius:8px;margin:15px 0;">\n          <strong>${e.timing}</strong>\n          ${e.locationNote?`<br><em style="font-size:0.95em;">${e.locationNote}</em>`:""}\n        </p>\n      `+o}const a=document.createElement("div");a.className="tooltip-modal active",a.innerHTML=`\n      <div class="tooltip-content">\n        <button class="tooltip-close" onclick="this.closest('.tooltip-modal').remove()">√ó</button>\n        <h3>${n.title}</h3>\n        ${o}\n      </div>\n    `,a.addEventListener("click",(e=>{e.target===a&&a.remove()})),document.body.appendChild(a)},e.addEventListener("change",(e=>{console.log("Lawn input changed",e.target.files),t.innerHTML="",c=e.target.files[0],c?(console.log("Creating preview for:",c.name),function(e,t){const n=document.createElement("img"),o=new FileReader;o.onload=()=>n.src=o.result,o.readAsDataURL(e),t.appendChild(n)}(c,t),n.disabled=!1,console.log("Analyze button enabled")):console.log("No file selected")}));const k=["lawn","grass","lawn mower","park bench","fountain","villa","lakeside","valley","geyser","alp","sandbar","promontory","seashore","cliff","coral reef"],x=["grass","lawn","plant","field","meadow","green"],M=["soil","ground","sand","beach","cliff","valley","geyser","alp","promontory","sandbar","lakeside"],C=["person","people","face","cat","dog","animal","pet","car","vehicle","indoor","furniture","screen","computer","phone","food","kitchen"];async function S(e,t){if("undefined"==typeof mobilenet)return console.warn("MobileNet not available, skipping photo validation"),{valid:!0};try{const n=await async function(){if(u)return u;if("undefined"==typeof mobilenet){console.log("Waiting for MobileNet to load...");let e=0;for(;"undefined"==typeof mobilenet&&e<50;)await new Promise((e=>setTimeout(e,100))),e++;if("undefined"==typeof mobilenet)throw new Error("MobileNet library failed to load")}return console.log("Loading MobileNet model..."),u=await mobilenet.load(),console.log("MobileNet model loaded successfully"),u}(),o=await n.classify(e);console.log(`MobileNet predictions for ${t}:`,o);for(let e=0;e<Math.min(3,o.length);e++){const n=o[e],a=n.className.toLowerCase();for(const e of C)if(a.includes(e)&&n.probability>.3)return{valid:!1,message:`This looks like a ${n.className}, not ${t}. Please upload a clear ${t} photo.`}}const a="lawn"===t?k:"grass"===t?x:M;return!o.some((e=>a.some((t=>e.className.toLowerCase().includes(t)))))&&o[0].probability>.4?{valid:!1,message:`This doesn't appear to be a ${t} photo. Please upload a clearer image.`}:{valid:!0}}catch(e){return console.warn("Validation failed, continuing:",e),{valid:!0}}}function $(e){if(!e)return"other";const t=e.toLowerCase().replace(/[_-]/g," "),n={grass:["grass","field"],tree:["tree","plant","bush"],structure:["house","building","fence","road","pavement"],bare:["soil","earth"],sky:["sky"]};for(const[e,o]of Object.entries(n))if(o.some((e=>t.includes(e))))return e;return"other"}function I(e){const t=new Map;for(const[n,o]of Object.entries(e))t.set(o.join(","),n);return t}async function P(e){const t=`\n      <div class="soil-prompt" id="soil-prompt">\n        <div class="soil-prompt-header">\n          <h3>üîç Bare Soil Detected (${(100*e).toFixed(1)}%)</h3>\n          <button onclick="toggleSoilPrompt()" class="collapse-btn" id="collapse-btn">\n            ‚ñº Collapse\n          </button>\n        </div>\n        <div class="soil-prompt-content" id="soil-prompt-content">\n          <p>For a deeper analysis, upload a close-up photo of the exposed soil.</p>\n          <p style="font-size:0.9em;opacity:0.8;">üì∏ Get closer and focus on one bare patch</p>\n          <p style="font-size:0.9em;opacity:0.8;">‚ö° We'll analyze texture, cracks, and moisture</p>\n          <p style="font-size:0.9em;opacity:0.8;">üîí Everything runs in your browser - no uploads!</p>\n          \n          <div style="margin-top:15px;">\n            <label for="soilInput" class="cta" style="cursor:pointer;display:inline-block;">\n              üì∑ Upload Soil Close-up\n            </label>\n            <input type="file" id="soilInput" accept="image/*" style="display:none;">\n            \n            <button onclick="toggleSoilPrompt()" \n                    style="margin-left:10px;padding:10px 20px;background:#ccc;border:none;border-radius:8px;cursor:pointer;">\n              Skip for now\n            </button>\n          </div>\n          \n          <div id="soil-preview" style="margin-top:15px;"></div>\n          <div id="soil-analysis-result" style="margin-top:15px;"></div>\n        </div>\n      </div>\n    `,n=document.createElement("div");n.innerHTML=t,o.appendChild(n),window.toggleSoilPrompt=function(){const e=document.getElementById("soil-prompt-content"),t=document.getElementById("collapse-btn"),n=document.getElementById("soil-prompt");"none"===e.style.display?(e.style.display="block",t.textContent="‚ñº Collapse",n.style.background="linear-gradient(135deg, #fff8e1 0%, #ffe0b2 100%)"):(e.style.display="none",t.textContent="‚ñ∂ Expand",n.style.background="#f5f5f5")};const a=document.getElementById("soilInput");a.addEventListener("change",(async e=>{if(p=e.target.files[0],!p)return;const t=document.getElementById("soil-preview");t.innerHTML="<p>‚è≥ Analyzing soil texture, cracks, and drainage...</p>";const n=new Image;n.src=URL.createObjectURL(p),await n.decode();const o=await S(n,"soil");if(!o.valid)return t.innerHTML=`\n          <p style="color:#c0392b;font-weight:600;">\n            ‚ùå ${o.message}\n          </p>\n          <p style="font-size:0.9em;opacity:0.8;">\n            Tip: get closer and focus on one bare patch of ground\n          </p>\n        `,void(a.value="");const r=function(e){const t=document.createElement("canvas"),n=t.getContext("2d");t.width=t.height=512,n.drawImage(e,0,0,512,512);const o=n.getImageData(0,0,512,512).data;let a=0,r=0,i=0,s=0,l=0;for(let e=0;e<o.length;e+=4){const t=o[e],n=o[e+1],c=o[e+2],d=(t+n+c)/3;s+=d,d<50&&l++,d<80?a++:d>180&&r++,t>1.2*n&&t>1.2*c&&i++}const c=o.length/4;return{darkRatio:a/c,lightRatio:r/c,reddishRatio:i/c,veryDarkRatio:l/c,avgBrightness:s/c}}(n),i=function(e){const t=512,n=document.createElement("canvas"),o=n.getContext("2d");n.width=n.height=t,o.drawImage(e,0,0,t,t);const a=o.getImageData(0,0,t,t).data,r=t;let i=0,s=0;function l(e,t){for(let n=-2;n<=2;n++)for(let o=-2;o<=2;o++){const i=e+o,s=t+n;if(i<0||s<0||i>=r||s>=512)continue;const l=4*(s*r+i);if(a[l+1]>1.15*a[l]&&a[l+1]>1.15*a[l+2])return!0}return!1}for(let e=2;e<510;e++){let t=0;for(let n=2;n<510;n++){const o=4*(e*r+n),c=(a[o]+a[o+1]+a[o+2])/3,d=(a[o+4]+a[o+5]+a[o+6])/3,p=(a[o+2048]+a[o+2048+1]+a[o+2048+2])/3,g=Math.abs(c-d)>35||Math.abs(c-p)>35,u=c<95;l(n,e)?(t>=20&&s++,t=0):u&&g?(t++,i++):(t>=20&&s++,t=0)}t>=20&&s++}const c=i/262144;return{crackData:c,longCrackSegments:s,hasCracks:c>.015&&s>=3}}(n),s=function(e){const t=512,n=document.createElement("canvas"),o=n.getContext("2d");n.width=n.height=t,o.drawImage(e,0,0,t,t);const a=o.getImageData(0,0,t,t).data,r=t;let i=0,s=0;for(let e=1;e<511;e++)for(let t=1;t<511;t++){const n=4*(e*r+t),o=a[n],l=a[n+1],c=a[n+2],d=(o+l+c)/3,p=Math.max(o,l,c),g=Math.min(o,l,c),u=d>125&&p-g<45;u&&s++;const m=(a[n+4]+a[n+5]+a[n+6])/3,h=(a[n+2048]+a[n+2048+1]+a[n+2048+2])/3,f=Math.abs(d-m)>22||Math.abs(d-h)>22;u&&f&&i++}const l=262144,c=s/l,d=i/l;return{plateRatio:c,edgeRatio:d,hasDesiccationCracks:c>.18&&d>.018}}(n),l=function(e,t=null,n=null){const o=document.createElement("canvas"),a=o.getContext("2d"),r=512;o.width=o.height=r,a.drawImage(e,0,0,r,r);const i=a.getImageData(0,0,r,r).data,s=r,l=262144;let c=0,d=0,p=0,g=null;t&&n&&(g=new Map,Object.entries(n).forEach((([e,t])=>{g.set(t.join(","),e.toLowerCase())})));const u=(e,n)=>{if(!g)return!1;const o=4*(n*s+e),a=`${t[o]},${t[o+1]},${t[o+2]}`,r=g.get(a)||"";return r.includes("tree")||r.includes("plant")||r.includes("grass")};for(let e=2;e<510;e++){let t=0;for(let n=2;n<510;n++){const o=4*(e*s+n),a=i[o],r=i[o+1],l=i[o+2],g=(a+r+l)/3,m=Math.max(a,r,l)-Math.min(a,r,l);if(u(n,e))t=0;else if(g<65&&l>.95*a&&l>.95*r&&m<35){c++,t++;const e=i[o-2048],n=i[o+2048],a=i[o-4],r=i[o+4];Math.max(e,n,a,r)-g>85&&d++}else t>p&&(p=t),t=0}t>p&&(p=t)}const m=c/l,h=d/l;return{puddleRatio:m,reflectionRatio:h,flatnessScore:p/s,hasPuddles:m>.025&&p>25.6&&h>.005}}(n),c=function(e,t,n,o){const a=[];if(n?.hasDesiccationCracks&&n.edgeRatio<.08){const e=n.edgeRatio>.02?"Severe":"Moderate";a.push({level:"high",category:"drought",title:`${e} Drought Cracking Detected`,message:"Polygonal soil cracking indicates prolonged drying and clay shrinkage. This pattern restricts root growth and reduces water infiltration. Apply deep, infrequent watering and incorporate organic matter to stabilize soil structure.",recommendations:["Water deeply 1‚Äì2 times per week instead of frequent shallow watering","Incorporate compost or organic matter to improve moisture retention","Apply mulch to reduce surface evaporation","Avoid heavy traffic while soil is dry"]})}if(o?.hasPuddles){const e=o.puddleRatio>.08||o.reflectionRatio>.04?"Severe":"Moderate";a.push({level:"high",category:"drainage",title:`${e} Drainage Issue Detected`,message:"Standing water or puddling suggests compacted soil or poor drainage. Excess moisture can suffocate roots and promote disease.",recommendations:["Core aerate to relieve compaction","Top-dress with compost or sand-organic blend","Improve grading to move water away from problem areas","Avoid irrigation until surface water drains"]})}if(t?.hasCracks){const e=t.crackData>.05?"Moderate":"Mild";a.push({level:"medium",category:"compaction",title:`${e} Surface Cracking Detected`,message:"Linear surface cracks can indicate drying or compaction stress near the soil surface. While less severe than drought cracking, this can still limit root expansion.",recommendations:["Monitor soil moisture levels","Light aeration or soil loosening may help","Avoid heavy foot traffic in affected areas"]})}return e&&("clay"===e.type&&a.push({level:"info",category:"texture",title:"Clay-Dominant Soil",message:"Clay soils retain moisture but drain slowly and are prone to cracking during dry periods.",recommendations:["Add organic matter regularly","Avoid working soil when wet or extremely dry","Use deep, infrequent watering cycles"]}),"sandy"===e.type&&a.push({level:"info",category:"texture",title:"Sandy Soil Detected",message:"Sandy soils drain quickly and dry out faster, requiring more frequent watering.",recommendations:["Water more frequently with smaller amounts","Add organic matter to improve water retention"]}),"loam"===e.type&&a.push({level:"info",category:"texture",title:"Loamy Soil Detected",message:"Loamy soil offers good balance between drainage and moisture retention.",recommendations:["Maintain organic matter levels","Continue balanced irrigation practices"]})),0===a.length&&a.push({level:"info",category:"general",title:"No Major Soil Issues Detected",message:"The soil surface appears stable with no significant cracking or drainage issues visible.",recommendations:["Maintain current watering practices","Monitor soil conditions seasonally"]}),a}(r,i,s,l);console.log(c);const d=function(e,t,n,o){const a=e.naturalWidth||e.width,r=e.naturalHeight||e.height,i=document.createElement("canvas"),s=i.getContext("2d");i.width=a,i.height=r,s.drawImage(e,0,0,a,r);const l=512,c=document.createElement("canvas"),d=c.getContext("2d");c.width=l,c.height=l,d.drawImage(e,0,0,l,l);const p=d.getImageData(0,0,l,l),g=p.data,u=l;if(o?.hasDesiccationCracks)for(let e=1;e<511;e++)for(let t=1;t<511;t++){const n=4*(e*u+t),o=g[n],a=g[n+1],r=g[n+2],i=(o+a+r)/3,s=Math.max(o,a,r),l=Math.min(o,a,r),c=i>125&&s-l<45,d=(g[n+4]+g[n+5]+g[n+6])/3,p=(g[n+2048]+g[n+2048+1]+g[n+2048+2])/3,m=Math.abs(i-d)>22||Math.abs(i-p)>22;c&&(g[n]=Math.min(255,g[n]+40),g[n+1]=Math.min(255,g[n+1]+25),g[n+2]=Math.max(0,g[n+2]-10)),c&&m&&(g[n]=Math.max(0,g[n]-40),g[n+1]=Math.max(0,g[n+1]-40),g[n+2]=Math.max(0,g[n+2]-40))}if(t?.hasCracks)for(let e=2;e<510;e++)for(let t=2;t<510;t++){const n=4*(e*u+t),o=(g[n]+g[n+1]+g[n+2])/3,a=(g[n+4]+g[n+5]+g[n+6])/3,r=(g[n+2048]+g[n+2048+1]+g[n+2048+2])/3;o<95&&(Math.abs(o-a)>35||Math.abs(o-r)>35)&&(g[n]=Math.min(255,g[n]+120),g[n+1]=Math.max(0,g[n+1]-60),g[n+2]=Math.max(0,g[n+2]-60))}if(n?.hasPuddles)for(let e=1;e<511;e++)for(let t=1;t<511;t++){const n=4*(e*u+t),o=g[n],a=g[n+1],r=g[n+2];(o+a+r)/3<65&&r>.95*o&&r>.95*a&&(g[n]=Math.max(0,g[n]-40),g[n+1]=Math.max(0,g[n+1]-40),g[n+2]=Math.min(255,g[n+2]+100))}const m=document.createElement("canvas"),h=m.getContext("2d");return m.width=l,m.height=l,h.putImageData(p,0,0),s.imageSmoothingEnabled=!1,s.globalAlpha=.65,s.drawImage(m,0,0,l,l,0,0,a,r),s.globalAlpha=1,i.toDataURL()}(n,i,l,s);t.innerHTML=`\n        <div style="display:flex;gap:15px;flex-wrap:wrap;margin-top:10px;">\n          <div style="flex:1;min-width:200px;">\n            <p style="font-weight:600;margin-bottom:5px;">Original</p>\n            <img src="${n.src}" style="width:100%;border-radius:8px;">\n          </div>\n          <div style="flex:1;min-width:200px;">\n            <p style="font-weight:600;margin-bottom:5px;">Analysis Overlay</p>\n            <img src="${d}" style="width:100%;border-radius:8px;">\n            <p style="font-size:0.85em;opacity:0.7;margin-top:5px;">\n              ${i>.08?"üî¥ Red = Cracks":""}\n              ${i>.08&&l.hasPuddles?" | ":""}\n              ${l.hasPuddles?"üîµ Blue = Puddles":""}\n            </p>\n          </div>\n        </div>\n      `;document.getElementById("soil-analysis-result").innerHTML=`\n        <div style="background:#f0f8f0;padding:15px;border-radius:8px;margin-top:15px;">\n          <h4>üå± Soil Close-up Analysis</h4>\n          ${c.map((e=>`<h4>${e.title}</h4>\n          <p style="margin:8px 0;">${e.message}</p>\n          ${e.recommendations?`<ul>\n                  ${e.recommendations.map((e=>`<li>${e}</li>`)).join("")}\n                </ul>`:""}\n\n            `)).join("")}\n          \n          ${i>.08||l.hasPuddles?`\n            <div style="margin-top:15px;padding:12px;background:#fff3cd;border-radius:6px;">\n              <strong>üìä Detection Details:</strong><br>\n              ${i>.08?`Crack coverage: ${(100*i).toFixed(1)}%<br>`:""}\n              ${l.hasPuddles?`Water pooling: ${(100*l.puddleRatio).toFixed(1)}%<br>`:""}\n              ${l.reflectionRatio>.01?`Reflective areas: ${(100*l.reflectionRatio).toFixed(1)}%`:""}\n            </div>\n          `:""}\n          \n          <p style="margin-top:12px;font-size:0.9em;opacity:0.7;">\n            üí° These insights complement your lawn analysis above\n          </p>\n        </div>\n      `}))}function E(e){const t=document.createElement("canvas"),n=t.getContext("2d");t.width=t.height=256,n.drawImage(e,0,0,256,256);const o=n.getImageData(0,0,256,256).data;let a=0,r=0,i=0,s=0;for(let e=0;e<o.length;e+=4){const t=o[e],n=o[e+1],l=o[e+2];n>1.15*t&&n>1.15*l?a++:t>140&&n>140&&l<120?r++:t>n&&n>l&&i++,s++}return{greenRatio:a/s,yellowRatio:r/s,brownRatio:i/s}}function R(e){return[11,0,1].includes(e)?"winter":[2,3,4].includes(e)?"spring":[5,6,7].includes(e)?"summer":"fall"}n.addEventListener("click",(async()=>{if(console.log("Analyze button clicked"),c){n.disabled=!0,o.style.display="none",i.style.display="block",w(0,"Starting analysis...");try{console.log("Starting analysis..."),w(5,"Loading image...");const e=new Image;e.src=URL.createObjectURL(c),await e.decode(),console.log("Image loaded successfully"),w(10,"Validating photo with AI..."),console.log("Calling validatePhoto...");const t=await S(e);if(console.log("Validation result:",t),!t.valid)return l.style.color="red",w(100,t.message),void setTimeout((()=>{l.style.color="",y(),n.disabled=!1}),4e3);w(20,"Preparing AI model...");const i=await async function(){return g||(await tf.ready(),w(10,"Loading AI model..."),g=await deeplab.load({base:"ade20k",quantizationBytes:2}),w(30,"Model loaded successfully"),g)}();w(60,"Analyzing lawn segmentation...");const s=await i.segment(e);w(70,"Processing segmentation data...");const p=r?.value||null,u=a?.value?.trim()||null,m=function(e,t,n,o){const a=new Map;Object.entries(t).forEach((([e,t])=>{a.set(t.join(","),e.toLowerCase())}));const r=[],i=[];for(let t=0;t<e.length;t+=4){const o=t/4%n,s=Math.floor(t/4/n),l=`${e[t]},${e[t+1]},${e[t+2]}`,c=a.get(l)||"";(c.includes("tree")||c.includes("plant"))&&r.push([o,s]),(c.includes("soil")||c.includes("earth"))&&i.push([o,s])}if(0===r.length||0===i.length)return!1;let s=0;const l=.08*Math.min(n,o);for(const[e,t]of i)for(const[n,o]of r){const a=e-n,r=t-o;if(a*a+r*r<l*l){s++;break}}return s/i.length>.25}(s.segmentationMap,s.legend,e.width,e.height);!function(e,t,n,o){const a=document.getElementById("originalCanvas"),r=document.getElementById("segmentationCanvas");a.width=r.width=n,a.height=r.height=o,a.getContext("2d").drawImage(e,0,0,n,o);const i=r.getContext("2d"),s=new ImageData(new Uint8ClampedArray(t),n,o);i.putImageData(s,0,0),a.style.display="block",r.style.display="block"}(e,s.segmentationMap,s.width,s.height);const f=R((new Date).getMonth());let b="winter"===f?function(e,t,n){const o=I(n),a={grass:0,dormant:0,tree:0,structure:0,bare:0,sky:0,other:0};let r=0;const i=document.createElement("canvas"),s=i.getContext("2d");i.width=i.height=256,s.drawImage(t,0,0,256,256);const l=s.getImageData(0,0,256,256).data;for(let t=0;t<e.length;t+=4){const n=`${e[t]},${e[t+1]},${e[t+2]}`;let i=$(o.get(n));if("grass"===i){const e=l[t],n=l[t+1],o=l[t+2];e>180&&n>160&&o>140&&(i="dormant")}a[i]=(a[i]||0)+1,"sky"!==i&&r++}return{grassPercent:a.grass/r,dormantPercent:a.dormant/r,treePercent:a.tree/r,structurePercent:a.structure/r,bareSoilPercent:a.bare/r,treeCoverage:a.tree}}(s.segmentationMap,e,s.legend):function(e,t){const n=I(t),o={grass:0,tree:0,structure:0,bare:0,pavement:0,fence:0,road:0,sky:0,other:0};let a=0;for(let t=0;t<e.length;t+=4){const r=`${e[t]},${e[t+1]},${e[t+2]}`,i=$(n.get(r));o[i]++,"sky"!==i&&a++}return{grassPercent:o.grass/a,treePercent:o.tree/a,structurePercent:o.structure/a,bareSoilPercent:o.bare/a,treeCoverage:o.tree}}(s.segmentationMap,s.legend);(100*b.grassPercent).toFixed(1),(100*b.treePercent).toFixed(1),(100*b.structurePercent).toFixed(1),(100*b.bareSoilPercent).toFixed(1);w(80,"Analyzing grass health...");let k=null;if(d.length){const e={greenRatio:0,yellowRatio:0,brownRatio:0};for(const t of d){const n=new Image;n.src=URL.createObjectURL(t),await n.decode();const o=E(n);e.greenRatio+=o.greenRatio,e.yellowRatio+=o.yellowRatio,e.brownRatio+=o.brownRatio}Object.keys(e).forEach((t=>e[t]/=d.length)),k=function({greenRatio:e,yellowRatio:t,brownRatio:n}){const o=e=>Math.max(0,Math.min(100,Math.round(e)));return{growthScore:o(100*e-80*t),protectionScore:o(50*(e+(1-n)))}}(e)}else k={growthScore:null,protectionScore:null};const x=function(e,t){return"winter"===t?"Grass may appear yellow in winter ‚Äì this is normal dormancy üå±":null===e?"Need to upload grass photos":null}(k.growthScore,f);w(85,"Loading grass identification guide...");const M=function(){const e=document.getElementById("grassInput");return e&&e.files?Array.from(e.files).slice(0,3).map((e=>URL.createObjectURL(e))):[]}();M.length>0?v(M):document.getElementById("grass-id-section").style.display="none",w(90,"Generating care plan...");const C=function(e){const t=R(e.month),n=function({bareSoilPercent:e,slopeHint:t}){let n="low";return e>.25&&(n="moderate"),e>.45&&(n="high"),"steep"===t&&e>.2&&(n="high"),n}(e),o=void 0!==e.treePercent&&e.treePercent>.15&&e.bareSoilPercent>.15,a="winter"===t&&void 0!==e.dormantPercent?Math.max(0,e.bareSoilPercent-e.dormantPercent):e.bareSoilPercent,r=a<.15;h={zipCode:e.zipCode,season:t};const i=[{week:"Week 1 ‚Äì Observe & Protect",actions:[...r?[]:["Avoid major lawn work."],"low"!==n?'Add light <span class="tooltip-trigger" onclick="showTooltip(\'mulch\')">mulch</span> or leaf cover to exposed soil.':"Leave grass clippings and thin branches where they fall."]},{week:"Week 2 ‚Äì Gentle Support",actions:[o?'üå≥ Trees detected with bare patches underneath. You can add <span class="tooltip-trigger" onclick="showTooltip(\'mulch\')">mulch</span> or <span class="tooltip-trigger" onclick="showTooltip(\'shadegrass\')">shade-tolerant plants</span> to prevent erosion.':e.growthScore<50&&"spring"===t?`Apply a thin <span class="tooltip-trigger"\n                 onclick="showTooltip('compost', {season: '${t}', zipCode: '${e.zipCode||""}'})">\n                 compost</span> top-dressing.`:"No fertilization needed.","steep"===e.slopeHint?"Avoid disturbing soil downhill on slopes.":"Limit foot traffic in thin areas."]},{week:"Week 3 ‚Äì Reassess",actions:["Observe runoff after rainfall.","high"===n?'Reinforce exposed patches with organic cover. <span class="tooltip-trigger" onclick="showTooltip(\'erosion\')">Learn about erosion risk</span>.':"No changes needed if soil remains covered."]},{week:"Week 4 ‚Äì Prepare Ahead",actions:["summer"===t?"Prepare shade or moisture-retaining cover.":"Plan adjustments for next growth window.",e.protectionScore>=60?"Maintain current coverage.":"Focus next month on improving coverage"]}];return i.forEach((n=>{a>.45?n.actions.push(`High bare soil detected ‚Äì prioritize replanting, <span class="tooltip-trigger" onclick="showTooltip('mulch')">mulch</span>, and <span class="tooltip-trigger" onclick="showTooltip('compost', {season: '${t}', zipCode: '${e.zipCode||""}'})">compost</span>!`):r&&n.actions.push("Excellent coverage! Keep maintaining your healthy lawn üåü")})),{plan:i,badge:r?"üèÖ Excellent Lawn Coverage!":null}}({...k,hasTreeBareProximity:m,bareSoilPercent:b.bareSoilPercent,dormantPercent:b.dormantPercent,treePercent:b.treePercent,treeCoverage:b.treeCoverage,slopeHint:p,zipCode:u,month:(new Date).getMonth()});w(100,"Analysis complete!"),o.innerHTML=`\n      ${function(e,t){return`\n    <h3>Segmentation Overview</h3>\n    <div style="display:flex;width:100%;height:40px;border-radius:6px;overflow:hidden;">\n      ${[{name:"Grass",pct:100*e.grassPercent,color:"green"},{name:"Other Plants",pct:100*e.treePercent,color:"darkgreen"},{name:"Structures",pct:100*e.structurePercent,color:"gray"},..."winter"===t&&void 0!==e.dormantPercent?[{name:"Dormant Grass",pct:100*e.dormantPercent,color:"#dcd0a1",tooltip:"Normal winter dormant grass"}]:[],{name:"Bare Soil",pct:100*e.bareSoilPercent,color:"brown"}].map((e=>`\n        <div style="\n          flex:${e.pct};\n          background:${e.color};\n          position: relative;\n        " title="${e.tooltip||`${e.name}: ${e.pct.toFixed(1)}%`}">\n        </div>\n      `)).join("")}\n    </div>\n  `}(b,f)}\n      <h3>Grass Health</h3>\n      Growth: ${null!==k.growthScore?k.growthScore+"/100":x}<br>\n      Protection: ${null!==k.protectionScore?k.protectionScore+"/100":x}\n      ${function({plan:e,badge:t}){return`\n    <h4>üå± 1-Month Low-Intervention Plan</h4>\n    ${t?`<div style="font-size:1.2em;color:#27ae60;margin-bottom:15px;">${t}</div>`:""}\n    ${e.map((e=>`\n      <div class="plan-week">\n        <strong>${e.week}</strong>\n        <ul>\n          ${e.actions.map((e=>`<li>${e}</li>`)).join("")}\n        </ul>\n      </div>\n    `)).join("")}\n  `}(C)}\n    `,o.style.display="block",b.bareSoilPercent>.2&&setTimeout((()=>{P(b.bareSoilPercent)}),500),setTimeout((()=>{y()}),1e3)}catch(e){console.error("Analysis error:",e),w(0,"Error during analysis. Please try again."),setTimeout((()=>{y()}),3e3)}n.disabled=!1}else console.log("No lawn image selected")}))}));