document.addEventListener("DOMContentLoaded",(function(){document.getElementById("year").textContent=(new Date).getFullYear();const e=document.getElementById("lawnInput"),t=document.getElementById("grassInput"),n=document.getElementById("lawnPreview"),r=document.getElementById("grassPreview"),o=document.getElementById("analyzeBtn"),a=document.getElementById("demo-result"),s=document.getElementById("zipInput"),i=document.getElementById("slopeInput");let c=null,l=[],d=null,g=null;async function u(){if(g)return g;const e=await fetch("./static/suggestions/grass_species_care_rules.json");return g=await e.json(),g}async function m(e){const t=document.getElementById("grass-id-section"),n=document.getElementById("user-grass-gallery"),r=document.getElementById("grass-card-grid");if(!t||!n||!r)return;t.style.display="block",n.innerHTML=e.slice(0,3).map((e=>`\n    <img src="${e}" alt="User grass photo">\n  `)).join("");const o=await async function(){const e=(await u()).species;return Object.entries(e).map((([e,t])=>({key:e,name:t.commonName,img:`/static/grass/${e}.jpg`,traits:[`${t.seasonType}-season`,`Shade: ${t.care.shadeTolerance}`,`Mow: ${t.care.mowHeight}`]})))}();r.innerHTML=o.map((e=>`\n    <div class="grass-card" onclick="showGrassRules('${e.key}')">\n      <img src="${e.img}" style="width:100%;border-radius:6px;">\n      <strong>${e.name}</strong>\n      <ul>\n        ${e.traits.map((e=>`<li>${e}</li>`)).join("")}\n      </ul>\n    </div>\n  `)).join("")}function h(e,t){const n=document.createElement("img"),r=new FileReader;r.onload=()=>n.src=r.result,r.readAsDataURL(e),t.appendChild(n)}function p(e){if(!e)return"other";const t=e.toLowerCase().replace(/[_-]/g," "),n={grass:["grass","field"],tree:["tree","plant","bush"],structure:["house","building","fence","road","pavement"],bare:["soil","earth"],sky:["sky"]};for(const[e,r]of Object.entries(n))if(r.some((e=>t.includes(e))))return e;return"other"}function w(e){const t=new Map;for(const[n,r]of Object.entries(e))t.set(r.join(","),n);return t}function y(e){const t=document.createElement("canvas"),n=t.getContext("2d");t.width=t.height=256,n.drawImage(e,0,0,256,256);const r=n.getImageData(0,0,256,256).data;let o=0,a=0,s=0,i=0;for(let e=0;e<r.length;e+=4){const t=r[e],n=r[e+1],c=r[e+2];n>1.15*t&&n>1.15*c?o++:t>140&&n>140&&c<120?a++:t>n&&n>c&&s++,i++}return{greenRatio:o/i,yellowRatio:a/i,brownRatio:s/i}}function f(e){return[11,0,1].includes(e)?"winter":[2,3,4].includes(e)?"spring":[5,6,7].includes(e)?"summer":"fall"}e.addEventListener("change",(e=>{n.innerHTML="",c=e.target.files[0],c&&(h(c,n),o.disabled=!1)})),t.addEventListener("change",(e=>{r.innerHTML="",l=[],Array.from(e.target.files).slice(0,3).forEach((e=>{l.push(e),h(e,r)}))})),o.addEventListener("click",(async()=>{if(!c)return;o.disabled=!0,a.style.display="none";const e=new Image;e.src=URL.createObjectURL(c),await e.decode();const t=await async function(){return d||(await tf.ready(),d=await deeplab.load({base:"ade20k",quantizationBytes:2}),d)}(),n=await t.segment(e),r=i?.value||null,g=s?.value?.trim()||null;!function(e,t,n,r){const o=document.getElementById("originalCanvas"),a=document.getElementById("segmentationCanvas");o.width=a.width=n,o.height=a.height=r,o.getContext("2d").drawImage(e,0,0,n,r);const s=a.getContext("2d"),i=new ImageData(new Uint8ClampedArray(t),n,r);s.putImageData(i,0,0),o.style.display="block",a.style.display="block"}(e,n.segmentationMap,n.width,n.height);const u=f((new Date).getMonth());let h="winter"===u?function(e,t,n){const r=w(n),o={grass:0,dormant:0,tree:0,structure:0,bare:0,sky:0,other:0};let a=0;const s=document.createElement("canvas"),i=s.getContext("2d");s.width=s.height=256,i.drawImage(t,0,0,256,256);const c=i.getImageData(0,0,256,256).data;for(let t=0;t<e.length;t+=4){const n=`${e[t]},${e[t+1]},${e[t+2]}`;let s=p(r.get(n));if("grass"===s){const e=c[t],n=c[t+1],r=c[t+2];e>180&&n>160&&r>140&&(s="dormant")}o[s]=(o[s]||0)+1,"sky"!==s&&a++}return{grassPercent:o.grass/a,dormantPercent:o.dormant/a,treePercent:o.tree/a,structurePercent:o.structure/a,bareSoilPercent:o.bare/a}}(n.segmentationMap,e,n.legend):function(e,t){const n=w(t),r={grass:0,tree:0,structure:0,bare:0,pavement:0,fence:0,road:0,sky:0,other:0};let o=0;for(let t=0;t<e.length;t+=4){const a=`${e[t]},${e[t+1]},${e[t+2]}`,s=p(n.get(a));r[s]++,"sky"!==s&&o++}return{grassPercent:r.grass/o,treePercent:r.tree/o,structurePercent:r.structure/o,bareSoilPercent:r.bare/o}}(n.segmentationMap,n.legend);(100*h.grassPercent).toFixed(1),(100*h.treePercent).toFixed(1),(100*h.structurePercent).toFixed(1),(100*h.bareSoilPercent).toFixed(1);let b=null;if(l.length){const e={greenRatio:0,yellowRatio:0,brownRatio:0};for(const t of l){const n=new Image;n.src=URL.createObjectURL(t),await n.decode();const r=y(n);e.greenRatio+=r.greenRatio,e.yellowRatio+=r.yellowRatio,e.brownRatio+=r.brownRatio}Object.keys(e).forEach((t=>e[t]/=l.length)),b=function({greenRatio:e,yellowRatio:t,brownRatio:n}){const r=e=>Math.max(0,Math.min(100,Math.round(e)));return{growthScore:r(100*e-80*t),protectionScore:r(50*(e+(1-n)))}}(e)}else b={growthScore:null,protectionScore:null};const v=function(e,t){return"winter"===t?"Grass may appear yellow in winter ‚Äî this is normal dormancy üå±":null===e?"Need to upload grass photos":null}(b.growthScore,u),P=function(){const e=document.getElementById("grassInput");return e&&e.files?Array.from(e.files).slice(0,3).map((e=>URL.createObjectURL(e))):[]}();P.length>0?m(P):document.getElementById("grass-id-section").style.display="none";const $=function(e){const t=f(e.month),n=function({bareSoilPercent:e,slopeHint:t}){let n="low";return e>.25&&(n="moderate"),e>.45&&(n="high"),"steep"===t&&e>.2&&(n="high"),n}(e),r="winter"===t&&void 0!==e.dormantPercent?Math.max(0,e.bareSoilPercent-e.dormantPercent):e.bareSoilPercent,o=r<.15,a=[{week:"Week 1 ‚Äî Observe & Protect",actions:["Avoid major lawn work.","low"!==n?"Add light mulch or leaf cover to exposed soil.":"Leave grass clippings and thin branches where they fall."]},{week:"Week 2 ‚Äî Gentle Support",actions:[e.growthScore<50&&"spring"===t?"Apply a thin compost top-dressing.":"No fertilization needed.","steep"===e.slopeHint?"Avoid disturbing soil downhill on slopes.":"Limit foot traffic in thin areas."]},{week:"Week 3 ‚Äî Reassess",actions:["Observe runoff after rainfall.","high"===n?"Reinforce exposed patches with organic cover.":"No changes needed if soil remains covered."]},{week:"Week 4 ‚Äî Prepare Ahead",actions:["summer"===t?"Prepare shade or moisture-retaining cover.":"Plan adjustments for next growth window.",e.protectionScore>=60?"Maintain current coverage.":"Focus next month on improving coverage"]}];return a.forEach((e=>{r>.45?e.actions.push("High bare soil detected ‚Äî prioritize replanting and mulch!"):o&&e.actions.push("Excellent coverage! Keep maintaining your healthy lawn üåü")})),{plan:a,badge:o?"üèÖ Excellent Lawn Coverage!":null}}({...b,bareSoilPercent:h.bareSoilPercent,dormantPercent:h.dormantPercent,slopeHint:r,zipCode:g,month:(new Date).getMonth()});a.innerHTML=`\n    ${function(e,t){return`\n    <h3>Segmentation Overview</h3>\n    <div style="display:flex;width:100%;height:40px;border-radius:6px;overflow:hidden;">\n      ${[{name:"Grass",pct:100*e.grassPercent,color:"green"},{name:"Other Plants",pct:100*e.treePercent,color:"darkgreen"},{name:"Structures",pct:100*e.structurePercent,color:"gray"},..."winter"===t&&void 0!==e.dormantPercent?[{name:"Dormant Grass",pct:100*e.dormantPercent,color:"#dcd0a1",tooltip:"Normal winter dormant grass"}]:[],{name:"Bare Soil",pct:100*e.bareSoilPercent,color:"brown"}].map((e=>`\n        <div style="\n          flex:${e.pct};\n          background:${e.color};\n          position: relative;\n        " title="${e.tooltip||`${e.name}: ${e.pct.toFixed(1)}%`}">\n        </div>\n      `)).join("")}\n    </div>\n  `}(h,u)}\n    <h3>Grass Health</h3>\n    Growth: ${null!==b.growthScore?b.growthScore+"/100":v}<br>\n    Protection: ${null!==b.protectionScore?b.protectionScore+"/100":v}\n    ${function({plan:e,badge:t}){return`\n    <h4>üå± 1-Month Low-Intervention Plan</h4>\n    ${t?`<div style="font-size:1.2em;color:#27ae60;margin-bottom:15px;">${t}</div>`:""}\n    ${e.map((e=>`\n      <div class="plan-week">\n        <strong>${e.week}</strong>\n        <ul>\n          ${e.actions.map((e=>`<li>${e}</li>`)).join("")}\n        </ul>\n      </div>\n    `)).join("")}\n  `}($)}\n  `,a.style.display="block",o.disabled=!1}))}));