document.addEventListener("DOMContentLoaded",(function(){document.getElementById("year").textContent=(new Date).getFullYear();const e=document.getElementById("lawnInput"),t=document.getElementById("grassInput"),n=document.getElementById("lawnPreview"),o=document.getElementById("grassPreview"),r=document.getElementById("analyzeBtn"),s=document.getElementById("demo-result"),i=document.getElementById("zipInput"),a=document.getElementById("slopeInput"),l=document.getElementById("progress-container"),c=document.getElementById("progress-fill"),d=document.getElementById("progress-text");let p=null,g=[],u=null,m=null,h=null;const w={compost:{title:"üå± Compost: Feed the Soil, Not Just the Grass",content:"\n        <p>Compost isn't fertilizer in the traditional sense ‚Äî it's food for the soil itself.</p>\n        \n        <p>Healthy lawns start below the surface. Compost adds organic matter that improves soil structure, supports beneficial microbes, and helps soil hold both water and nutrients more effectively.</p>\n        \n        <p>That's why SoilMend often recommends light compost use instead of aggressive treatments.</p>\n        \n        <h4>What Compost Actually Does</h4>\n        <p>When you apply compost, you're not forcing growth ‚Äî you're restoring balance.</p>\n        \n        <p>Compost helps:</p>\n        <ul>\n          <li>Improve compacted or lifeless soil</li>\n          <li>Increase water retention during dry periods</li>\n          <li>Reduce runoff and erosion after heavy rain</li>\n          <li>Support steady, resilient grass growth over time</li>\n        </ul>\n        \n        <p>This is especially important in areas with bare soil, slopes, or tree cover where grass struggles.</p>\n        \n        <h4>When SoilMend Suggests Compost</h4>\n        <p>In your SoilMend plan, you may see guidance like:</p>\n        <p style=\"font-style:italic;color:var(--green);\">\"Apply a thin compost top-dressing.\"</p>\n        \n        <p>This usually means:</p>\n        <ul>\n          <li>Grass growth looks weak or patchy</li>\n          <li>Bare soil is increasing</li>\n          <li>The season supports recovery (often spring or fall)</li>\n          <li>You want improvement without disturbing the lawn</li>\n        </ul>\n        \n        <p>Compost is suggested only when it helps ‚Äî never by default.</p>\n        \n        <h4>How to Apply Compost (Gently)</h4>\n        <p>You don't need to dig or till.</p>\n        \n        <p>For most lawns:</p>\n        <ol>\n          <li>Use finished, dark, earthy-smelling compost</li>\n          <li>Spread a very thin layer (about ¬º inch)</li>\n          <li>Focus on bare or thinning areas</li>\n          <li>Let rain and soil life do the work</li>\n        </ol>\n        \n        <p><strong>If you can still see the grass blades, you've applied the right amount.</strong></p>\n        \n        <h4>Compost vs. Fertilizer</h4>\n        <table>\n          <tr>\n            <th>Compost</th>\n            <th>Fertilizer</th>\n          </tr>\n          <tr>\n            <td>Improves soil health</td>\n            <td>Pushes fast growth</td>\n          </tr>\n          <tr>\n            <td>Slow, lasting benefits</td>\n            <td>Short-term results</td>\n          </tr>\n          <tr>\n            <td>Reduces erosion & runoff</td>\n            <td>Can increase runoff</td>\n          </tr>\n          <tr>\n            <td>Supports microbes</td>\n            <td>Feeds plants directly</td>\n          </tr>\n        </table>\n        \n        <p><strong>SoilMend prioritizes compost because healthy soil solves problems before they show up above ground.</strong></p>\n      "},mulch:{title:"üçÇ Mulch: Nature's Soil Protector",content:"\n        <p>Mulch is any material that covers bare soil to protect it from erosion, retain moisture, and support soil life.</p>\n        \n        <h4>Why Mulch Matters</h4>\n        <ul>\n          <li>Prevents soil from washing away during rain</li>\n          <li>Keeps soil temperature stable</li>\n          <li>Reduces water evaporation</li>\n          <li>Breaks down slowly to feed soil organisms</li>\n        </ul>\n        \n        <h4>Types of Mulch</h4>\n        <ul>\n          <li><strong>Organic:</strong> Wood chips, leaves, grass clippings, straw</li>\n          <li><strong>Living:</strong> Low-growing groundcover plants</li>\n          <li><strong>Temporary:</strong> Cardboard or burlap for severe erosion</li>\n        </ul>\n        \n        <p>SoilMend recommends light, organic mulch for exposed areas ‚Äî especially on slopes.</p>\n      "},erosion:{title:"üíß Understanding Erosion Risk",content:"\n        <p>Erosion happens when soil is exposed and unprotected, allowing water or wind to carry it away.</p>\n        \n        <h4>What Increases Erosion Risk</h4>\n        <ul>\n          <li>Bare soil (no grass or plant cover)</li>\n          <li>Slopes and hillsides</li>\n          <li>Heavy rainfall or runoff</li>\n          <li>Compacted soil that can't absorb water</li>\n        </ul>\n        \n        <h4>How SoilMend Estimates Risk</h4>\n        <p>We analyze:</p>\n        <ul>\n          <li>Percentage of bare soil in your photo</li>\n          <li>Slope information you provide</li>\n          <li>Seasonal rainfall patterns for your area</li>\n        </ul>\n        \n        <p><strong>Low risk:</strong> Good grass coverage, flat terrain<br>\n        <strong>Moderate risk:</strong> Some bare patches, gentle slopes<br>\n        <strong>High risk:</strong> Significant bare soil or steep slopes</p>\n      "}};function y(){l.style.display="none"}function f(e,t){c.style.width=e+"%",c.textContent=e+"%",d.textContent=t}async function b(){if(m)return m;const e=await fetch("./static/suggestions/grass_species_care_rules.json");return m=await e.json(),m}async function v(e){const t=document.getElementById("grass-id-section"),n=document.getElementById("user-grass-gallery"),o=document.getElementById("grass-card-grid");if(!t||!n||!o)return;t.style.display="block",n.innerHTML=e.slice(0,3).map((e=>`\n    <img src="${e}" alt="User grass photo">\n  `)).join("");const r=await async function(){const e=(await b()).species;return Object.entries(e).map((([e,t])=>({key:e,name:t.commonName,img:`./static/grass/${e}.jpg`,traits:[`${t.seasonType}-season`,`Shade: ${t.care.shadeTolerance}`,`Mow: ${t.care.mowHeight}`]})))}();o.innerHTML=r.map((e=>`\n    <div class="grass-card" onclick="showGrassRules('${e.key}')">\n      <img src="${e.img}" style="width:100%;border-radius:6px;">\n      <strong>${e.name}</strong>\n      <ul>\n        ${e.traits.map((e=>`<li>${e}</li>`)).join("")}\n      </ul>\n    </div>\n  `)).join("")}function k(e,t){const n=document.createElement("img"),o=new FileReader;o.onload=()=>n.src=o.result,o.readAsDataURL(e),t.appendChild(n)}function S(e){if(!e)return"other";const t=e.toLowerCase().replace(/[_-]/g," "),n={grass:["grass","field"],tree:["tree","plant","bush"],structure:["house","building","fence","road","pavement"],bare:["soil","earth"],sky:["sky"]};for(const[e,o]of Object.entries(n))if(o.some((e=>t.includes(e))))return e;return"other"}function I(e){const t=new Map;for(const[n,o]of Object.entries(e))t.set(o.join(","),n);return t}function P(e){const t=document.createElement("canvas"),n=t.getContext("2d");t.width=t.height=256,n.drawImage(e,0,0,256,256);const o=n.getImageData(0,0,256,256).data;let r=0,s=0,i=0,a=0;for(let e=0;e<o.length;e+=4){const t=o[e],n=o[e+1],l=o[e+2];n>1.15*t&&n>1.15*l?r++:t>140&&n>140&&l<120?s++:t>n&&n>l&&i++,a++}return{greenRatio:r/a,yellowRatio:s/a,brownRatio:i/a}}function $(e){return[11,0,1].includes(e)?"winter":[2,3,4].includes(e)?"spring":[5,6,7].includes(e)?"summer":"fall"}window.showTooltip=function(e,t={}){const n=w[e];if(!n)return;let o=n.content;if("compost"===e&&t.season){const e=function(e,t){let n="";if(e){const t=parseInt(e);t>=77e3&&t<=77099?n="Houston area - mild winters allow year-round application":t>=1e4&&t<=14999?n="Northern climate - spring and fall are best windows":t>=3e4&&t<=39999?n="Southern climate - avoid mid-summer heat stress":t>=9e4&&t<=96699&&(n="Western climate - timing varies by elevation and moisture")}return{timing:{winter:"Wait until early spring when soil can be worked",spring:"Ideal time! Apply compost now for active growth season",summer:"Can apply, but water retention is key - compost helps!",fall:"Excellent timing! Helps prepare lawn for winter"}[t],locationNote:n}}(t.zipCode,t.season);o=`\n        ${t.zipCode?`<div class="location-badge">üìç ${t.zipCode}</div>`:""}\n        <h4>Best Time to Apply (${t.season})</h4>\n        <p style="background:var(--bg);padding:15px;border-radius:8px;margin:15px 0;">\n          <strong>${e.timing}</strong>\n          ${e.locationNote?`<br><em style="font-size:0.95em;">${e.locationNote}</em>`:""}\n        </p>\n      `+o}const r=document.createElement("div");r.className="tooltip-modal active",r.innerHTML=`\n      <div class="tooltip-content">\n        <button class="tooltip-close" onclick="this.closest('.tooltip-modal').remove()">√ó</button>\n        <h3>${n.title}</h3>\n        ${o}\n      </div>\n    `,r.addEventListener("click",(e=>{e.target===r&&r.remove()})),document.body.appendChild(r)},e.addEventListener("change",(e=>{n.innerHTML="",p=e.target.files[0],p&&(k(p,n),r.disabled=!1)})),t.addEventListener("change",(e=>{o.innerHTML="",g=[],Array.from(e.target.files).slice(0,3).forEach((e=>{g.push(e),k(e,o)}))})),r.addEventListener("click",(async()=>{if(p){r.disabled=!0,s.style.display="none",l.style.display="block",f(0,"Starting analysis...");try{f(5,"Loading image...");const e=new Image;e.src=URL.createObjectURL(p),await e.decode(),f(15,"Preparing AI model...");const t=await async function(){return u||(await tf.ready(),f(10,"Loading AI model..."),u=await deeplab.load({base:"ade20k",quantizationBytes:2}),f(30,"Model loaded successfully"),u)}();f(40,"Analyzing lawn segmentation...");const n=await t.segment(e);f(60,"Processing segmentation data...");const o=a?.value||null,r=i?.value?.trim()||null;!function(e,t,n,o){const r=document.getElementById("originalCanvas"),s=document.getElementById("segmentationCanvas");r.width=s.width=n,r.height=s.height=o,r.getContext("2d").drawImage(e,0,0,n,o);const i=s.getContext("2d"),a=new ImageData(new Uint8ClampedArray(t),n,o);i.putImageData(a,0,0),r.style.display="block",s.style.display="block"}(e,n.segmentationMap,n.width,n.height);const l=$((new Date).getMonth());let c="winter"===l?function(e,t,n){const o=I(n),r={grass:0,dormant:0,tree:0,structure:0,bare:0,sky:0,other:0};let s=0;const i=document.createElement("canvas"),a=i.getContext("2d");i.width=i.height=256,a.drawImage(t,0,0,256,256);const l=a.getImageData(0,0,256,256).data;for(let t=0;t<e.length;t+=4){const n=`${e[t]},${e[t+1]},${e[t+2]}`;let i=S(o.get(n));if("grass"===i){const e=l[t],n=l[t+1],o=l[t+2];e>180&&n>160&&o>140&&(i="dormant")}r[i]=(r[i]||0)+1,"sky"!==i&&s++}return{grassPercent:r.grass/s,dormantPercent:r.dormant/s,treePercent:r.tree/s,structurePercent:r.structure/s,bareSoilPercent:r.bare/s}}(n.segmentationMap,e,n.legend):function(e,t){const n=I(t),o={grass:0,tree:0,structure:0,bare:0,pavement:0,fence:0,road:0,sky:0,other:0};let r=0;for(let t=0;t<e.length;t+=4){const s=`${e[t]},${e[t+1]},${e[t+2]}`,i=S(n.get(s));o[i]++,"sky"!==i&&r++}return{grassPercent:o.grass/r,treePercent:o.tree/r,structurePercent:o.structure/r,bareSoilPercent:o.bare/r}}(n.segmentationMap,n.legend);(100*c.grassPercent).toFixed(1),(100*c.treePercent).toFixed(1),(100*c.structurePercent).toFixed(1),(100*c.bareSoilPercent).toFixed(1);f(70,"Analyzing grass health...");let d=null;if(g.length){const e={greenRatio:0,yellowRatio:0,brownRatio:0};for(const t of g){const n=new Image;n.src=URL.createObjectURL(t),await n.decode();const o=P(n);e.greenRatio+=o.greenRatio,e.yellowRatio+=o.yellowRatio,e.brownRatio+=o.brownRatio}Object.keys(e).forEach((t=>e[t]/=g.length)),d=function({greenRatio:e,yellowRatio:t,brownRatio:n}){const o=e=>Math.max(0,Math.min(100,Math.round(e)));return{growthScore:o(100*e-80*t),protectionScore:o(50*(e+(1-n)))}}(e)}else d={growthScore:null,protectionScore:null};const m=function(e,t){return"winter"===t?"Grass may appear yellow in winter ‚Äì this is normal dormancy üå±":null===e?"Need to upload grass photos":null}(d.growthScore,l);f(80,"Loading grass identification guide...");const w=function(){const e=document.getElementById("grassInput");return e&&e.files?Array.from(e.files).slice(0,3).map((e=>URL.createObjectURL(e))):[]}();w.length>0?v(w):document.getElementById("grass-id-section").style.display="none",f(90,"Generating care plan...");const b=function(e){const t=$(e.month),n=function({bareSoilPercent:e,slopeHint:t}){let n="low";return e>.25&&(n="moderate"),e>.45&&(n="high"),"steep"===t&&e>.2&&(n="high"),n}(e),o="winter"===t&&void 0!==e.dormantPercent?Math.max(0,e.bareSoilPercent-e.dormantPercent):e.bareSoilPercent,r=o<.15;h={zipCode:e.zipCode,season:t};const s=[{week:"Week 1 ‚Äì Observe & Protect",actions:["Avoid major lawn work.","low"!==n?'Add light <span class="tooltip-trigger" onclick="showTooltip(\'mulch\')">mulch</span> or leaf cover to exposed soil.':"Leave grass clippings and thin branches where they fall."]},{week:"Week 2 ‚Äì Gentle Support",actions:[e.growthScore<50&&"spring"===t?`Apply a thin <span class="tooltip-trigger" onclick="showTooltip('compost', {season: '${t}', zipCode: '${e.zipCode||""}'})">compost</span> top-dressing.`:"No fertilization needed.","steep"===e.slopeHint?"Avoid disturbing soil downhill on slopes.":"Limit foot traffic in thin areas."]},{week:"Week 3 ‚Äì Reassess",actions:["Observe runoff after rainfall.","high"===n?'Reinforce exposed patches with organic cover. <span class="tooltip-trigger" onclick="showTooltip(\'erosion\')">Learn about erosion risk</span>.':"No changes needed if soil remains covered."]},{week:"Week 4 ‚Äì Prepare Ahead",actions:["summer"===t?"Prepare shade or moisture-retaining cover.":"Plan adjustments for next growth window.",e.protectionScore>=60?"Maintain current coverage.":"Focus next month on improving coverage"]}];return s.forEach((n=>{o>.45?n.actions.push(`High bare soil detected ‚Äì prioritize replanting, <span class="tooltip-trigger" onclick="showTooltip('mulch')">mulch</span>, and <span class="tooltip-trigger" onclick="showTooltip('compost', {season: '${t}', zipCode: '${e.zipCode||""}'})">compost</span>!`):r&&n.actions.push("Excellent coverage! Keep maintaining your healthy lawn üåü")})),{plan:s,badge:r?"üèÖ Excellent Lawn Coverage!":null}}({...d,bareSoilPercent:c.bareSoilPercent,dormantPercent:c.dormantPercent,slopeHint:o,zipCode:r,month:(new Date).getMonth()});f(100,"Analysis complete!"),s.innerHTML=`\n      ${function(e,t){return`\n    <h3>Segmentation Overview</h3>\n    <div style="display:flex;width:100%;height:40px;border-radius:6px;overflow:hidden;">\n      ${[{name:"Grass",pct:100*e.grassPercent,color:"green"},{name:"Other Plants",pct:100*e.treePercent,color:"darkgreen"},{name:"Structures",pct:100*e.structurePercent,color:"gray"},..."winter"===t&&void 0!==e.dormantPercent?[{name:"Dormant Grass",pct:100*e.dormantPercent,color:"#dcd0a1",tooltip:"Normal winter dormant grass"}]:[],{name:"Bare Soil",pct:100*e.bareSoilPercent,color:"brown"}].map((e=>`\n        <div style="\n          flex:${e.pct};\n          background:${e.color};\n          position: relative;\n        " title="${e.tooltip||`${e.name}: ${e.pct.toFixed(1)}%`}">\n        </div>\n      `)).join("")}\n    </div>\n  `}(c,l)}\n      <h3>Grass Health</h3>\n      Growth: ${null!==d.growthScore?d.growthScore+"/100":m}<br>\n      Protection: ${null!==d.protectionScore?d.protectionScore+"/100":m}\n      ${function({plan:e,badge:t}){return`\n    <h4>üå± 1-Month Low-Intervention Plan</h4>\n    ${t?`<div style="font-size:1.2em;color:#27ae60;margin-bottom:15px;">${t}</div>`:""}\n    ${e.map((e=>`\n      <div class="plan-week">\n        <strong>${e.week}</strong>\n        <ul>\n          ${e.actions.map((e=>`<li>${e}</li>`)).join("")}\n        </ul>\n      </div>\n    `)).join("")}\n  `}(b)}\n    `,s.style.display="block",setTimeout((()=>{y()}),1e3)}catch(e){console.error("Analysis error:",e),f(0,"Error during analysis. Please try again."),setTimeout((()=>{y()}),3e3)}r.disabled=!1}}))}));